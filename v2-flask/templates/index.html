<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Chat Analytics</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00d084;
            --secondary-color: #06c755;
            --dark-color: #2c3e50;
            --light-gray: #f8f9fa;
            --border-color: #e9ecef;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tango, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .main-header {
            text-align: center;
            padding: 3rem 0 2rem 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 2rem;
            border-radius: 0 0 50px 50px;
        }
        
        .main-header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            margin: 2rem 0;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .upload-area.dragover {
            border-color: var(--secondary-color);
            background: linear-gradient(45deg, #f8fff9, #e8f5e8);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .stats-card {
            margin: 15px 0;
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            background: white;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .stats-card .card-body {
            padding: 2rem;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .chart-container {
            margin: 2rem 0;
            padding: 2rem;
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: white;
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }
        
        .loading .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 4px;
        }
        
        .wordcloud-container {
            text-align: center;
            margin: 2rem 0;
            padding: 2rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .btn-custom {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary.btn-custom {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
        }
        
        .btn-primary.btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .section-header {
            text-align: center;
            margin: 3rem 0 2rem 0;
            position: relative;
        }
        
        .section-header h2 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 1rem;
        }
        
        .section-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
        }
        
        .fun-facts {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .fun-facts .metric-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .user-stats-row {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .user-stats-row:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .progress-custom {
            height: 10px;
            border-radius: 5px;
            background: #f0f0f0;
        }
        
        .progress-custom .progress-bar {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 5px;
        }
        
        .alert-custom {
            border: none;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
        }
        
        .text-purple {
            color: #6f42c1 !important;
        }
        
        .participant-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .participant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .border-4 {
            border-width: 4px !important;
        }
        
        .fun-facts-card {
            background: white !important;
        }
        
        .fun-fact-item {
            background-color: #f8f9fa !important;
            color: #212529 !important;
            border: 1px solid #e9ecef !important;
            font-weight: 500;
        }
        
        .fun-fact-item:hover {
            background-color: #e9ecef !important;
            transform: translateX(5px);
            transition: all 0.2s ease;
        }
    </style>
</head>
<body>
    <div class="main-header">
        <div class="container">
            <h1><i class="fab fa-line"></i> LINE Chat Analytics</h1>
            <p class="lead">Discover insights from your conversations with beautiful visualizations and comprehensive statistics</p>
        </div>
    </div>

    <div class="container")

        <!-- File Upload Section -->
        <div class="row">
            <div class="col-12">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3 class="mb-3">Drop your LINE chat file here</h3>
                    <p class="mb-4 text-muted">Or click the button below to select a .txt file from your device</p>
                    <input type="file" id="fileInput" accept=".txt" style="display: none;">
                    <button class="btn btn-primary btn-custom" id="chooseFileBtn">
                        <i class="fas fa-file-upload me-2"></i>Choose Chat File
                    </button>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Supported format: LINE chat export (.txt files)
                        </small>
                    </div>
                </div>
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h4 class="mt-3">Processing your chat file...</h4>
                    <p class="text-muted">This may take a moment depending on file size</p>
                </div>
                <div id="uploadStatus"></div>
            </div>
        </div>

        <!-- Stats Section -->
        <div id="statsSection" style="display: none;" class="fade-in">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar me-3"></i>Chat Overview</h2>
            </div>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-comments fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="card-title mb-1">Total Messages</h6>
                                    <div class="stats-number" id="totalMessages">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-users fa-2x text-success"></i>
                                </div>
                                <div>
                                    <h6 class="card-title mb-1">Participants</h6>
                                    <div class="stats-number text-success" id="totalParticipants">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-images fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h6 class="card-title mb-1">Photos</h6>
                                    <div class="stats-number text-warning" id="totalPhotos">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-laugh fa-2x text-info"></i>
                                </div>
                                <div>
                                    <h6 class="card-title mb-1">Stickers</h6>
                                    <div class="stats-number text-info" id="totalStickers">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-calendar-alt fa-2x text-secondary"></i>
                                </div>
                                <div>
                                    <h6 class="card-title mb-1">Chat Duration</h6>
                                    <p class="card-text mb-0" id="dateRange">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Stats -->
        <div id="userStatsSection" style="display: none;" class="fade-in">
            <div class="section-header">
                <h2><i class="fas fa-user-friends me-3"></i>Participant Analysis</h2>
            </div>
            <div class="chart-container">
                <div id="userStats"></div>
            </div>
        </div>
        
        <!-- Fun Facts Section -->
        <div id="funFactsSection" style="display: none;" class="fade-in">
            <div class="section-header">
                <h2><i class="fas fa-star me-3"></i>Fun Facts</h2>
            </div>
            <div class="fun-facts">
                <div class="row" id="funFactsContent">
                    <!-- Fun facts will be populated here -->
                </div>
            </div>
        </div>

        <!-- Visualizations Section -->
        <div id="visualizationsSection" style="display: none;" class="fade-in">
            <div class="section-header">
                <h2><i class="fas fa-chart-line me-3"></i>Interactive Analytics</h2>
            </div>
            
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-trophy me-2 text-warning"></i>Most Popular Messages</h4>
                        <div id="topMessagesChart"></div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-user-chart me-2 text-primary"></i>Messages by Participant</h4>
                        <div id="messagesPerUserChart"></div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-clock me-2 text-info"></i>Activity by Hour</h4>
                        <div id="messagesByHourChart"></div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-calendar-week me-2 text-success"></i>Activity by Day of Week</h4>
                        <div id="messagesByDowChart"></div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-file-alt me-2 text-secondary"></i>Message Types Distribution</h4>
                        <div id="chatTypesChart"></div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-chart-area me-2 text-purple"></i>Messages Over Time</h4>
                        <div id="messagesOverTimeChart"></div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-fire me-2 text-danger"></i>Activity Heatmap</h4>
                        <div id="activityHeatmapChart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Word Prediction Section -->
        <div id="predictionSection" style="display: none;" class="fade-in">
            <div class="section-header">
                <h2><i class="fas fa-brain me-3"></i>Who Wrote This?</h2>
            </div>
            
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-robot me-2 text-primary"></i>Text Author Prediction</h4>
                        <p class="text-muted mb-4">Enter some text and see who is most likely to have written it based on chat patterns</p>
                        
                        <div class="mb-4">
                            <div class="input-group input-group-lg">
                                <textarea 
                                    class="form-control" 
                                    id="predictionInput" 
                                    placeholder="Type a message here to predict who would write it..."
                                    rows="3"
                                    style="resize: none; border-radius: 15px 0 0 15px;"
                                ></textarea>
                                <button 
                                    class="btn btn-primary btn-custom" 
                                    type="button" 
                                    id="predictBtn"
                                    style="border-radius: 0 15px 15px 0;"
                                >
                                    <i class="fas fa-magic me-2"></i>Predict
                                </button>
                            </div>
                        </div>
                        
                        <div id="predictionResult" style="display: none;">
                            <div class="alert alert-info alert-custom">
                                <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Prediction Results</h5>
                                <div id="predictionContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Statistics Section -->
        <div id="advancedStatsSection" style="display: none;" class="fade-in">
            <div class="section-header">
                <h2><i class="fas fa-microscope me-3"></i>Individual Participant Insights</h2>
            </div>
            
            <!-- Participant Insights -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-user-friends me-2 text-primary"></i>Detailed User Analysis</h4>
                        <div id="participantInsights"></div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Individual Response Patterns -->
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-clock me-2 text-warning"></i>Individual Response Patterns</h4>
                        <div id="individualResponsePatterns"></div>
                    </div>
                </div>
                
                <!-- Communication Styles -->
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-comments me-2 text-info"></i>Communication Styles</h4>
                        <div id="communicationStyles"></div>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Relationship Metrics -->
            <div class="section-header mt-4">
                <h2><i class="fas fa-heart me-3"></i>Relationship Dynamics</h2>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-exchange-alt me-2 text-danger"></i>Connection Analysis</h4>
                        <div id="relationshipMetrics"></div>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Conversation Dynamics & Temporal Patterns -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-chart-line me-2 text-success"></i>Conversation Dynamics</h4>
                        <div id="conversationDynamics"></div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-calendar-alt me-2 text-primary"></i>Temporal Patterns</h4>
                        <div id="temporalPatterns"></div>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Engagement Metrics -->
            <div class="section-header mt-4">
                <h2><i class="fas fa-fire me-3"></i>Engagement Analysis</h2>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-chart-bar me-2 text-warning"></i>User Engagement Scores</h4>
                        <div id="engagementMetrics"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wordcloud Section -->
        <div id="wordcloudSection" style="display: none;" class="fade-in">
            <div class="section-header">
                <h2><i class="fas fa-cloud me-3"></i>Word Analysis</h2>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="wordcloud-container">
                        <h4 class="mb-3"><i class="fas fa-cloud-word me-2"></i>Word Cloud</h4>
                        <p class="text-muted mb-4">Visual representation of most frequently used words</p>
                        <img id="wordcloudImg" style="max-width: 100%; height: auto; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" />
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="chart-container">
                        <h4 class="mb-3"><i class="fas fa-list-ol me-2 text-primary"></i>Top Words</h4>
                        <div id="topWordsContainer">
                            <p class="text-muted">Most frequently used words will appear here...</p>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="wordStats">Word statistics will appear here</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-5">
            <div class="col-12 text-center">
                <p class="text-muted">
                    <small>
                        Privacy Notice: All analysis is performed locally. Your chat data is not stored on any server.
                    </small>
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const chooseFileBtn = document.getElementById('chooseFileBtn');
        const loading = document.getElementById('loading');
        const uploadStatus = document.getElementById('uploadStatus');
        
        let isProcessing = false;

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && !isProcessing) {
                handleFile(files[0]);
            }
        });

        // Separate click handler for the button
        chooseFileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!isProcessing) {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', (e) => {
            console.log('File input change event triggered');
            if (e.target.files.length > 0 && !isProcessing) {
                handleFile(e.target.files[0]);
            }
            // Clear the input to allow selecting the same file again if needed
            e.target.value = '';
        });

        async function handleFile(file) {
            if (isProcessing) {
                console.log('Already processing a file, ignoring...');
                return;
            }
            
            isProcessing = true;
            console.log('Handling file:', file.name, file.size);
            
            if (!file.name.endsWith('.txt')) {
                showStatus('error', 'Please select a .txt file');
                isProcessing = false;
                return;
            }

            loading.style.display = 'block';
            uploadStatus.innerHTML = '';
            chooseFileBtn.disabled = true;
            chooseFileBtn.textContent = 'Processing...';

            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('Sending upload request...');
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                
                // Handle different response types
                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    // If we can't parse JSON, it might be an HTML error page (like 413)
                    if (response.status === 413) {
                        showStatus('error', 'File too large! Maximum size allowed is 100MB. Please try with a smaller file.');
                        return;
                    }
                    throw new Error(`Server error (${response.status}): Unable to parse response`);
                }
                
                console.log('Upload result:', result);
                
                if (result.success) {
                    showStatus('success', result.message);
                    await loadAnalysis();
                } else {
                    showStatus('error', result.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                if (error.message.includes('413') || error.message.includes('too large')) {
                    showStatus('error', 'File too large! Maximum size allowed is 100MB. Please try with a smaller file.');
                } else {
                    showStatus('error', 'Upload failed: ' + error.message);
                }
            }

            loading.style.display = 'none';
            chooseFileBtn.disabled = false;
            chooseFileBtn.textContent = 'Choose File';
            isProcessing = false;
        }

        function showStatus(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
            uploadStatus.innerHTML = `
                <div class="alert ${alertClass} alert-custom mt-3 fade-in">
                    <i class="${icon} me-2"></i>${message}
                </div>
            `;
        }

        async function loadAnalysis() {
            try {
                // Load stats
                const statsResponse = await fetch('/stats');
                const stats = await statsResponse.json();
                
                // Load advanced statistics first to get personalized fun facts
                const advancedStatsResponse = await fetch('/advanced_stats');
                const advancedStatsData = await advancedStatsResponse.json();
                
                // Display stats with advanced data for fun facts
                displayStats(stats, advancedStatsData);

                // Load visualizations
                const vizResponse = await fetch('/visualizations');
                const visualizations = await vizResponse.json();
                displayVisualizations(visualizations);

                // Load wordcloud
                const wordcloudResponse = await fetch('/wordcloud');
                const wordcloudData = await wordcloudResponse.json();
                displayWordcloud(wordcloudData);

                // Load word frequencies
                const wordFreqResponse = await fetch('/word_frequency');
                const wordFreqData = await wordFreqResponse.json();
                displayWordFrequencies(wordFreqData);

                // Display advanced statistics
                displayAdvancedStats(advancedStatsData);

            } catch (error) {
                console.error('Error loading analysis:', error);
                showStatus('error', 'Failed to load analysis results');
            }
        }

        function displayStats(stats, advancedStats = null) {
            // Basic stats
            document.getElementById('totalMessages').textContent = formatNumber(stats.total_messages || 0);
            document.getElementById('totalParticipants').textContent = stats.participants || 0;
            document.getElementById('dateRange').textContent = stats.date_range || 'Unknown';
            
            // Chat type stats
            document.getElementById('totalPhotos').textContent = formatNumber(stats.chat_type_counts?.['[Photo]'] || 0);
            document.getElementById('totalStickers').textContent = formatNumber(stats.chat_type_counts?.['[Sticker]'] || 0);

            // Display enhanced user stats
            const userStatsDiv = document.getElementById('userStats');
            let userStatsHTML = '<h5 class="mb-4">Message Distribution by Participant</h5>';
            
            if (stats.user_message_counts) {
                for (const [user, count] of Object.entries(stats.user_message_counts)) {
                    const percentage = ((count / stats.total_messages) * 100).toFixed(1);
                    userStatsHTML += `
                        <div class="user-stats-row">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-circle fa-2x text-primary me-3"></i>
                                    <div>
                                        <strong>${user}</strong>
                                        <small class="text-muted d-block">${formatNumber(count)} messages</small>
                                    </div>
                                </div>
                                <span class="badge bg-primary rounded-pill">${percentage}%</span>
                            </div>
                            <div class="progress progress-custom">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
            }
            userStatsDiv.innerHTML = userStatsHTML;

            // Display fun facts with advanced stats for personalization
            displayFunFacts(stats, advancedStats);

            // Show stats sections with animation
            setTimeout(() => {
                document.getElementById('statsSection').style.display = 'block';
                document.getElementById('userStatsSection').style.display = 'block';
                document.getElementById('funFactsSection').style.display = 'block';
            }, 300);
        }
        
        function displayFunFacts(stats, advancedStats = null) {
            const funFactsDiv = document.getElementById('funFactsContent');
            let funFactsHTML = '';
            
            // Check if we have personalized fun facts from advanced stats
            if (advancedStats && advancedStats.personalized_fun_facts) {
                funFactsHTML += '<div class="col-12 mb-4"><h4 class="text-center text-primary"><i class="fas fa-sparkles me-2"></i>Personal Fun Facts</h4></div>';
                
                for (const [user, facts] of Object.entries(advancedStats.personalized_fun_facts)) {
                    funFactsHTML += `
                        <div class="col-lg-6 mb-4">
                            <div class="card border-0 shadow-sm h-100 fun-facts-card">
                                <div class="card-header bg-gradient-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-user-star me-2"></i>${user}'s Profile</h5>
                                </div>
                                <div class="card-body bg-white">
                                    <div class="d-flex flex-column gap-2">
                    `;
                    
                    facts.forEach(fact => {
                        funFactsHTML += `
                            <div class="fun-fact-item d-flex align-items-center p-3 rounded">
                                <span style="font-size: 0.95em; line-height: 1.4;">${fact}</span>
                            </div>
                        `;
                    });
                    
                    funFactsHTML += `
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Fallback to general fun facts if personalized ones aren't available
                if (stats.chat_type_counts) {
                    const facts = [
                        { icon: 'fas fa-images', label: 'Photos Shared', value: formatNumber(stats.chat_type_counts['[Photo]'] || 0), color: 'warning' },
                        { icon: 'fas fa-laugh', label: 'Stickers Sent', value: formatNumber(stats.chat_type_counts['[Sticker]'] || 0), color: 'info' },
                        { icon: 'fas fa-video', label: 'Videos Shared', value: formatNumber(stats.chat_type_counts['[Video]'] || 0), color: 'danger' },
                        { icon: 'fas fa-phone-slash', label: 'Missed Calls', value: formatNumber(stats.chat_type_counts['☎ Missed call'] || 0), color: 'secondary' },
                        { icon: 'fas fa-file', label: 'Files Shared', value: formatNumber(stats.chat_type_counts['[File]'] || 0), color: 'success' },
                        { icon: 'fas fa-microphone', label: 'Voice Messages', value: formatNumber(stats.chat_type_counts['[Voice message]'] || 0), color: 'primary' }
                    ];
                    
                    facts.forEach(fact => {
                        if (parseInt(fact.value) > 0) {
                            funFactsHTML += `
                                <div class="col-md-4 col-sm-6">
                                    <div class="metric-card">
                                        <div class="d-flex align-items-center">
                                            <i class="${fact.icon} fa-2x me-3"></i>
                                            <div>
                                                <div class="metric-value">${fact.value}</div>
                                                <div class="metric-label">${fact.label}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
            }
            
            funFactsDiv.innerHTML = funFactsHTML;
        }
        
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function displayVisualizations(viz) {
            const plotConfig = {
                responsive: true,
                displayModeBar: false,
                showTips: false
            };
            
            if (viz.top_messages) {
                const plotData = JSON.parse(viz.top_messages);
                Plotly.newPlot('topMessagesChart', plotData.data, {
                    ...plotData.layout,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, sans-serif', size: 12 }
                }, plotConfig);
            }
            
            if (viz.messages_per_user) {
                const plotData = JSON.parse(viz.messages_per_user);
                Plotly.newPlot('messagesPerUserChart', plotData.data, {
                    ...plotData.layout,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, sans-serif', size: 12 }
                }, plotConfig);
            }
            
            if (viz.messages_by_hour) {
                const plotData = JSON.parse(viz.messages_by_hour);
                Plotly.newPlot('messagesByHourChart', plotData.data, {
                    ...plotData.layout,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, sans-serif', size: 12 }
                }, plotConfig);
            }
            
            if (viz.messages_by_dow) {
                const plotData = JSON.parse(viz.messages_by_dow);
                Plotly.newPlot('messagesByDowChart', plotData.data, {
                    ...plotData.layout,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, sans-serif', size: 12 }
                }, plotConfig);
            }
            
            if (viz.chat_types) {
                const plotData = JSON.parse(viz.chat_types);
                Plotly.newPlot('chatTypesChart', plotData.data, {
                    ...plotData.layout,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, sans-serif', size: 12 }
                }, plotConfig);
            }
            
            if (viz.messages_over_time) {
                const plotData = JSON.parse(viz.messages_over_time);
                Plotly.newPlot('messagesOverTimeChart', plotData.data, {
                    ...plotData.layout,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, sans-serif', size: 12 }
                }, plotConfig);
            }
            
            if (viz.activity_heatmap) {
                const plotData = JSON.parse(viz.activity_heatmap);
                Plotly.newPlot('activityHeatmapChart', plotData.data, {
                    ...plotData.layout,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, sans-serif', size: 12 }
                }, plotConfig);
            }

            setTimeout(() => {
                document.getElementById('visualizationsSection').style.display = 'block';
                document.getElementById('predictionSection').style.display = 'block';
                document.getElementById('advancedStatsSection').style.display = 'block';
            }, 600);
        }

        function displayWordcloud(data) {
            if (data.wordcloud) {
                document.getElementById('wordcloudImg').src = 'data:image/png;base64,' + data.wordcloud;
                setTimeout(() => {
                    document.getElementById('wordcloudSection').style.display = 'block';
                }, 900);
            }
        }
        
        function displayWordFrequencies(data) {
            if (data.word_frequencies) {
                const container = document.getElementById('topWordsContainer');
                let html = '';
                
                const words = Object.entries(data.word_frequencies).slice(0, 15);
                words.forEach(([word, count], index) => {
                    const percentage = ((count / words[0][1]) * 100).toFixed(0);
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" style="background: #f8f9fa;">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-2">${index + 1}</span>
                                <span class="fw-bold" style="font-size: 1.1em;">${word}</span>
                            </div>
                            <div class="text-end">
                                <span class="text-primary fw-bold">${count}</span>
                                <div class="progress mt-1" style="height: 4px; width: 60px;">
                                    <div class="progress-bar" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Update word statistics
                const statsText = `${data.total_unique_words} unique words, ${formatNumber(data.total_words)} total words`;
                document.getElementById('wordStats').textContent = statsText;
            }
        }
        
        function displayAdvancedStats(data) {
            // Participant Insights - Detailed individual analysis
            if (data.participant_insights) {
                let insightsHTML = '<div class="row">';
                
                for (const [user, insights] of Object.entries(data.participant_insights)) {
                    insightsHTML += `
                        <div class="col-lg-6 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-gradient-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>${user}</h5>
                                    <small>Activity: ${insights.activity_percentage}% of total messages</small>
                                </div>
                                <div class="card-body">
                                    <!-- Message Types -->
                                    <h6 class="text-primary mb-3"><i class="fas fa-chart-pie me-2"></i>Message Types</h6>
                                    <div class="row g-2 mb-3">
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <i class="fas fa-comments text-primary"></i>
                                                <div class="fw-bold">${insights.text_messages}</div>
                                                <small>Text</small>
                                            </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <i class="fas fa-images text-warning"></i>
                                                <div class="fw-bold">${insights.photos_sent}</div>
                                                <small>Photos</small>
                                            </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <i class="fas fa-laugh text-info"></i>
                                                <div class="fw-bold">${insights.stickers_sent}</div>
                                                <small>Stickers</small>
                                            </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <i class="fas fa-microphone text-success"></i>
                                                <div class="fw-bold">${insights.voice_messages}</div>
                                                <small>Voice</small>
                                            </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <i class="fas fa-video text-danger"></i>
                                                <div class="fw-bold">${insights.videos_sent}</div>
                                                <small>Videos</small>
                                            </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <i class="fas fa-phone text-purple"></i>
                                                <div class="fw-bold">${insights.calls_made}</div>
                                                <small>Calls</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Text Analysis -->
                                    <h6 class="text-success mb-2"><i class="fas fa-text-width me-2"></i>Text Style</h6>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between">
                                            <small>Avg Length:</small>
                                            <strong>${insights.avg_message_length} chars</strong>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>Emojis Used:</small>
                                            <strong>${insights.total_emojis_used}</strong>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <small>Most Active:</small>
                                            <strong>${insights.most_active_hour}:00</strong>
                                        </div>
                                    </div>
                                    
                                    <!-- Top Emojis -->
                                    <div class="mb-2">
                                        <h6 class="text-warning mb-2"><i class="fas fa-smile me-2"></i>Favorite Emojis</h6>
                                        <div class="d-flex flex-wrap gap-1">`;
                    
                    if (Object.keys(insights.top_emojis).length > 0) {
                        for (const [emoji, count] of Object.entries(insights.top_emojis)) {
                            insightsHTML += `
                                <span class="badge bg-light text-dark" style="font-size: 0.9em;">
                                    ${emoji} ${count}
                                </span>`;
                        }
                    } else {
                        insightsHTML += '<small class="text-muted">No emojis used</small>';
                    }
                    
                    insightsHTML += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                insightsHTML += '</div>';
                document.getElementById('participantInsights').innerHTML = insightsHTML;
            }
            
            // Individual Response Patterns - Enhanced
            if (data.individual_response_patterns) {
                let responseHTML = '';
                
                // Sort users by response speed (fastest first)
                const sortedUsers = Object.entries(data.individual_response_patterns)
                    .sort(([,a], [,b]) => a.avg_response_time_minutes - b.avg_response_time_minutes);
                
                sortedUsers.forEach(([user, patterns], index) => {
                    const rankEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏃';
                    const speedBadgeColor = patterns.avg_response_time_minutes < 1 ? 'success' : 
                                          patterns.avg_response_time_minutes < 5 ? 'warning' : 
                                          patterns.avg_response_time_minutes < 30 ? 'info' : 'secondary';
                    
                    responseHTML += `
                        <div class="card border-start border-warning border-4 mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-title text-warning mb-0">
                                        ${rankEmoji} <i class="fas fa-user-circle me-2"></i>${user}
                                    </h6>
                                    <span class="badge bg-${speedBadgeColor}">${patterns.response_style}</span>
                                </div>
                                
                                <!-- Response Speed Metrics -->
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <div class="bg-light p-2 rounded text-center">
                                            <div class="fw-bold text-primary">${patterns.avg_response_time_minutes}min</div>
                                            <small class="text-muted">Average Response</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-light p-2 rounded text-center">
                                            <div class="fw-bold text-success">${patterns.fastest_response_minutes}min</div>
                                            <small class="text-muted">Fastest Response</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Response Statistics -->
                                <div class="row g-2">
                                    <div class="col-4 text-center">
                                        <div class="fw-bold text-success">${patterns.super_quick_responses_count}</div>
                                        <small class="text-muted">⚡ Instant</small>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="fw-bold text-warning">${patterns.quick_responses_count}</div>
                                        <small class="text-muted">🏃 Quick</small>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="fw-bold text-info">${patterns.slow_responses_count}</div>
                                        <small class="text-muted">🤔 Slow</small>
                                    </div>
                                </div>
                                
                                <!-- Additional Stats -->
                                <hr class="my-3">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted">Started Conversations</small>
                                        <div class="fw-bold">${patterns.conversations_started}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Response Rate</small>
                                        <div class="fw-bold">${patterns.response_rate_percentage}%</div>
                                    </div>
                                </div>
                                
                                <!-- Activity Time Pattern -->
                                ${patterns.night_owl_messages > 10 ? '<span class="badge bg-dark me-1">🌙 Night Owl</span>' : ''}
                                ${patterns.early_bird_messages > 5 ? '<span class="badge bg-warning me-1">🌅 Early Bird</span>' : ''}
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('individualResponsePatterns').innerHTML = responseHTML;
            }
            
            // Communication Styles
            if (data.communication_styles) {
                let stylesHTML = '';
                
                for (const [user, style] of Object.entries(data.communication_styles)) {
                    stylesHTML += `
                        <div class="card border-start border-info border-4 mb-3">
                            <div class="card-body">
                                <h6 class="card-title text-info">
                                    <i class="fas fa-user-circle me-2"></i>${user}'s Style
                                </h6>
                                
                                <!-- Message Length Distribution -->
                                <div class="mb-3">
                                    <small class="text-muted">Message Length Preference</small>
                                    <div class="progress mb-1" style="height: 20px;">
                                        <div class="progress-bar bg-success" style="width: ${style.short_messages_percentage}%">
                                            ${style.short_messages_percentage}% Short
                                        </div>
                                        <div class="progress-bar bg-warning" style="width: ${style.medium_messages_percentage}%">
                                            ${style.medium_messages_percentage}% Medium
                                        </div>
                                        <div class="progress-bar bg-info" style="width: ${style.long_messages_percentage}%">
                                            ${style.long_messages_percentage}% Long
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Communication Traits -->
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted">Questions Asked</small>
                                        <div class="fw-bold">${style.questions_asked} (${style.question_frequency}%)</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Exclamations</small>
                                        <div class="fw-bold">${style.exclamations_used} (${style.exclamation_frequency}%)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('communicationStyles').innerHTML = stylesHTML;
            }
            
            // NEW: Relationship Metrics
            if (data.relationship_metrics) {
                let relationHTML = '';
                
                for (const [pair, metrics] of Object.entries(data.relationship_metrics)) {
                    const balanceWidth = metrics.balance_score * 2; // Scale to 100%
                    const balanceColor = balanceWidth > 80 ? 'success' : balanceWidth > 60 ? 'info' : 'warning';
                    
                    relationHTML += `
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <h5 class="card-title text-primary mb-3">
                                    <i class="fas fa-users me-2"></i>${pair}
                                </h5>
                                
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4 text-center">
                                        <div class="bg-light p-3 rounded">
                                            <div class="h4 mb-1">${metrics.connection_strength}</div>
                                            <small class="text-muted">Connection Strength</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="bg-light p-3 rounded">
                                            <div class="h4 mb-1">${metrics.message_ratio}</div>
                                            <small class="text-muted">Message Ratio</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="bg-light p-3 rounded">
                                            <div class="h4 mb-1">${metrics.mutual_responses}</div>
                                            <small class="text-muted">Mutual Responses</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">Conversation Balance</small>
                                        <small class="fw-bold">${metrics.balance_score}%</small>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-${balanceColor}" style="width: ${balanceWidth}%">
                                            ${metrics.balance_score >= 40 ? 'Well Balanced' : 'Unbalanced'}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted">Response Rate</small>
                                        <div class="fw-bold">${metrics.response_rate}%</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Total Interactions</small>
                                        <div class="fw-bold">${metrics.mutual_responses}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('relationshipMetrics').innerHTML = relationHTML || '<p class="text-muted">Not enough data for relationship analysis</p>';
            }
            
            // NEW: Conversation Dynamics
            if (data.conversation_dynamics) {
                const dynamics = data.conversation_dynamics;
                let dynamicsHTML = '';
                
                if (dynamics.longest_streak) {
                    dynamicsHTML += `
                        <div class="card border-start border-success border-4 mb-3">
                            <div class="card-body">
                                <h6 class="text-success"><i class="fas fa-fire me-2"></i>Longest Message Streak</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="h3 mb-0">${dynamics.longest_streak.count} messages</div>
                                        <small class="text-muted">by ${dynamics.longest_streak.user}</small>
                                    </div>
                                    <i class="fas fa-award fa-3x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (dynamics.avg_conversation_length) {
                    dynamicsHTML += `
                        <div class="card border-start border-info border-4 mb-3">
                            <div class="card-body">
                                <h6 class="text-info"><i class="fas fa-comments me-2"></i>Conversation Stats</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted">Avg Length</small>
                                        <div class="fw-bold">${dynamics.avg_conversation_length} messages</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Longest</small>
                                        <div class="fw-bold">${dynamics.longest_conversation} messages</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Total Convos</small>
                                        <div class="fw-bold">${dynamics.total_conversations}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (dynamics.peak_activity) {
                    dynamicsHTML += `
                        <div class="card border-start border-warning border-4 mb-3">
                            <div class="card-body">
                                <h6 class="text-warning"><i class="fas fa-chart-line me-2"></i>Activity Peaks</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted">Peak Hour</small>
                                        <div class="fw-bold">${dynamics.peak_activity.hour}:00 (${dynamics.peak_activity.messages} msgs)</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Quiet Hour</small>
                                        <div class="fw-bold">${dynamics.peak_activity.quiet_hour}:00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('conversationDynamics').innerHTML = dynamicsHTML;
            }
            
            // NEW: Temporal Patterns
            if (data.temporal_patterns) {
                const patterns = data.temporal_patterns;
                let patternsHTML = '';
                
                if (patterns.weekend_vs_weekday) {
                    const weekendData = patterns.weekend_vs_weekday;
                    patternsHTML += `
                        <div class="card border-start border-primary border-4 mb-3">
                            <div class="card-body">
                                <h6 class="text-primary"><i class="fas fa-calendar-week me-2"></i>Weekend vs Weekday</h6>
                                <div class="mb-2">
                                    <span class="badge bg-primary mb-2">${weekendData.preference}</span>
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted">Weekend</small>
                                        <div class="fw-bold">${weekendData.weekend_messages} (${weekendData.weekend_percentage}%)</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Weekday</small>
                                        <div class="fw-bold">${weekendData.weekday_messages}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (patterns.chat_trend) {
                    const trend = patterns.chat_trend;
                    patternsHTML += `
                        <div class="card border-start border-success border-4 mb-3">
                            <div class="card-body">
                                <h6 class="text-success"><i class="fas fa-chart-area me-2"></i>Chat Trend</h6>
                                <div class="mb-2">
                                    <span class="badge bg-success">${trend.trend}</span>
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <small class="text-muted">Peak Month</small>
                                        <div class="fw-bold">${trend.most_active_month}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Growth Rate</small>
                                        <div class="fw-bold">${trend.growth_rate}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (patterns.seasonal_preference) {
                    const season = patterns.seasonal_preference;
                    patternsHTML += `
                        <div class="card border-start border-info border-4 mb-3">
                            <div class="card-body">
                                <h6 class="text-info"><i class="fas fa-leaf me-2"></i>Seasonal Favorite</h6>
                                <div class="h4 mb-0">${season.favorite_season}</div>
                                <small class="text-muted">${season.messages} messages</small>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('temporalPatterns').innerHTML = patternsHTML;
            }
            
            // NEW: Engagement Metrics
            if (data.engagement_metrics) {
                let engagementHTML = '<div class="row">';
                
                // Sort by engagement score
                const sortedEngagement = Object.entries(data.engagement_metrics)
                    .sort(([,a], [,b]) => b.engagement_score - a.engagement_score);
                
                sortedEngagement.forEach(([user, metrics], index) => {
                    const scoreColor = metrics.engagement_score >= 70 ? 'danger' : 
                                      metrics.engagement_score >= 50 ? 'warning' : 
                                      metrics.engagement_score >= 30 ? 'info' : 'secondary';
                    const medal = index === 0 ? '🏆' : index === 1 ? '🥈' : index === 2 ? '🥉' : '⭐';
                    
                    engagementHTML += `
                        <div class="col-lg-6 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0">
                                            ${medal} <i class="fas fa-user me-2"></i>${user}
                                        </h6>
                                        <span class="badge bg-${scoreColor}">${metrics.engagement_level}</span>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <small>Engagement Score</small>
                                            <strong>${metrics.engagement_score}/100</strong>
                                        </div>
                                        <div class="progress" style="height: 12px;">
                                            <div class="progress-bar bg-${scoreColor}" 
                                                 style="width: ${metrics.engagement_score}%"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-2 small">
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <div class="fw-bold">${metrics.message_contribution}%</div>
                                                <small class="text-muted">Messages</small>
                                            </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <div class="fw-bold">${metrics.media_activity}%</div>
                                                <small class="text-muted">Media</small>
                                            </div>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="bg-light p-2 rounded">
                                                <div class="fw-bold text-truncate">${metrics.interaction_quality}</div>
                                                <small class="text-muted">Quality</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                engagementHTML += '</div>';
                document.getElementById('engagementMetrics').innerHTML = engagementHTML;
            }
        }
        
        // Word Prediction Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const predictBtn = document.getElementById('predictBtn');
            const predictionInput = document.getElementById('predictionInput');
            const predictionResult = document.getElementById('predictionResult');
            const predictionContent = document.getElementById('predictionContent');
            
            if (predictBtn) {
                predictBtn.addEventListener('click', async function() {
                    const text = predictionInput.value.trim();
                    
                    if (!text) {
                        alert('Please enter some text to predict');
                        return;
                    }
                    
                    try {
                        predictBtn.disabled = true;
                        predictBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
                        
                        const response = await fetch('/predict_user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ text: text })
                        });
                        
                        const result = await response.json();
                        
                        if (result.error) {
                            throw new Error(result.error);
                        }
                        
                        let resultHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-crown me-2 text-warning"></i>Most Likely Author:</h6>
                                    <div class="alert alert-success">
                                        <h5 class="mb-1">${result.prediction}</h5>
                                        <small>Confidence: ${result.confidence}%</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-bar me-2 text-info"></i>All Predictions:</h6>
                        `;
                        
                        for (const [user, score] of Object.entries(result.scores)) {
                            resultHTML += `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>${user}</span>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-2" style="width: 100px; height: 8px;">
                                            <div class="progress-bar" style="width: ${score}%"></div>
                                        </div>
                                        <span class="badge bg-primary">${score}%</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        resultHTML += `
                                </div>
                            </div>
                        `;
                        
                        predictionContent.innerHTML = resultHTML;
                        predictionResult.style.display = 'block';
                        
                    } catch (error) {
                        console.error('Prediction error:', error);
                        predictionContent.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error: ${error.message}
                            </div>
                        `;
                        predictionResult.style.display = 'block';
                    } finally {
                        predictBtn.disabled = false;
                        predictBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Predict';
                    }
                });
                
                // Allow Enter key to trigger prediction
                predictionInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        predictBtn.click();
                    }
                });
            }
        });

        async function testConnection() {
            try {
                const response = await fetch('/test');
                const result = await response.json();
                alert('Connection test: ' + result.message);
                console.log('Test result:', result);
            } catch (error) {
                alert('Connection failed: ' + error.message);
                console.error('Test error:', error);
            }
        }
    </script>
</body>
</html>
